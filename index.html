<script>
    const cloudName = 'dt9zydui9'; // Seu cloud_name
    const uploadPreset = 'sofa-textura'; // O nome do upload_preset configurado no Cloudinary

    let sofaUrl = '';
    let tecidoUrl = '';

    // Função para fazer upload da imagem para o Cloudinary
    function uploadImage(file, callback) {
        console.log('Arquivo selecionado para upload:', file); // Verifique se o arquivo está correto
        const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                console.error('Erro no upload:', response.statusText); // Exibe o erro no upload
                throw new Error(response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Upload realizado com sucesso. URL:', data.secure_url); // Exibe a URL gerada
            callback(data.secure_url); // Retorna a URL da imagem carregada
        })
        .catch(err => console.error('Erro no upload:', err));
    }

    // Upload da imagem do sofá
    document.getElementById('sofaUpload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) {
            console.error('Nenhum arquivo de sofá selecionado.');
            return;
        }
        uploadImage(file, function(url) {
            sofaUrl = url;
            console.log('URL do sofá:', sofaUrl);
        });
    });

    // Upload da imagem do tecido
    document.getElementById('tecidoUpload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) {
            console.error('Nenhum arquivo de tecido selecionado.');
            return;
        }
        uploadImage(file, function(url) {
            tecidoUrl = url;
            console.log('URL do tecido:', tecidoUrl);
        });
    });

    // Aplicar a textura do tecido sobre a imagem do sofá
    document.getElementById('applyTextureBtn').addEventListener('click', function() {
        if (sofaUrl && tecidoUrl) {
            const resultImage = document.getElementById('resultImage');
            const transformationUrl = `https://res.cloudinary.com/${cloudName}/image/upload/l_${tecidoUrl.replace('https://res.cloudinary.com/'+cloudName+'/image/upload/', '')},fl_cutter/${sofaUrl.replace('https://res.cloudinary.com/'+cloudName+'/image/upload/', '')}`;

            console.log('URL de transformação gerada:', transformationUrl);
            resultImage.src = transformationUrl;
        } else {
            console.error('URLs das imagens não estão prontas. Verifique os uploads.');
            alert('Por favor, faça o upload das duas imagens.');
        }
    });
</script>
